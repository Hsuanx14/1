name: ðŸš€ æ§‹å»ºä¸¦éƒ¨ç½²åˆ° Docker Hub + Azure

on:
  push:
    branches:
      - main
      - claude/migrate-azure-docs-*
  pull_request:
    branches:
      - main
  workflow_dispatch:  # å…è¨±æ‰‹å‹•è§¸ç™¼

env:
  DOCKER_IMAGE_NAME: teacher-roster-backend
  AZURE_CONTAINER_NAME: teacher-roster-backend

jobs:
  # =====================================================
  # Job 1: æ§‹å»ºä¸¦æŽ¨é€åˆ° Docker Hub
  # =====================================================
  build-and-push-dockerhub:
    name: ðŸ“¦ æ§‹å»ºä¸¦æŽ¨é€åˆ° Docker Hub
    runs-on: ubuntu-latest

    steps:
      - name: ðŸ“¥ æª¢å‡ºä»£ç¢¼
        uses: actions/checkout@v4

      - name: ðŸ” ç™»å…¥ Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: ðŸ—ï¸ è¨­ç½® Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: ðŸ“ æå–å…ƒæ•¸æ“š
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ secrets.DOCKERHUB_USERNAME }}/${{ env.DOCKER_IMAGE_NAME }}
          tags: |
            type=ref,event=branch
            type=ref,event=pr
            type=sha,prefix={{branch}}-
            type=raw,value=latest,enable={{is_default_branch}}

      - name: ðŸ³ æ§‹å»ºä¸¦æŽ¨é€åˆ° Docker Hub
        uses: docker/build-push-action@v5
        with:
          context: ./backend
          file: ./backend/Dockerfile
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=registry,ref=${{ secrets.DOCKERHUB_USERNAME }}/${{ env.DOCKER_IMAGE_NAME }}:buildcache
          cache-to: type=registry,ref=${{ secrets.DOCKERHUB_USERNAME }}/${{ env.DOCKER_IMAGE_NAME }}:buildcache,mode=max

      - name: âœ… Docker Hub æŽ¨é€æˆåŠŸ
        run: |
          echo "ðŸŽ‰ æ˜ åƒæª”å·²æˆåŠŸæŽ¨é€åˆ° Docker Hubï¼"
          echo "ðŸ“¦ æ˜ åƒæª”: ${{ secrets.DOCKERHUB_USERNAME }}/${{ env.DOCKER_IMAGE_NAME }}"
          echo "ðŸ·ï¸ æ¨™ç±¤: ${{ steps.meta.outputs.tags }}"

  # =====================================================
  # Job 2: æ§‹å»ºä¸¦éƒ¨ç½²åˆ° Azureï¼ˆå¯é¸ï¼‰
  # =====================================================
  build-and-deploy-azure:
    name: â˜ï¸ æ§‹å»ºä¸¦éƒ¨ç½²åˆ° Azure
    runs-on: ubuntu-latest
    # é»˜èªç¦ç”¨ï¼Œéœ€è¦æ™‚è«‹ç§»é™¤ä¸‹é¢é€™è¡Œæˆ–æ”¹ç‚º true
    if: false

    steps:
      - name: ðŸ“¥ æª¢å‡ºä»£ç¢¼
        uses: actions/checkout@v4

      - name: ðŸ” ç™»å…¥ Azure
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: ðŸ” ç™»å…¥ Azure Container Registry
        run: |
          az acr login --name ${{ secrets.AZURE_REGISTRY_NAME }}

      - name: ðŸ—ï¸ æ§‹å»ºä¸¦æŽ¨é€åˆ° ACR
        run: |
          cd backend
          docker build -t ${{ secrets.AZURE_REGISTRY_NAME }}.azurecr.io/${{ env.DOCKER_IMAGE_NAME }}:${{ github.sha }} .
          docker build -t ${{ secrets.AZURE_REGISTRY_NAME }}.azurecr.io/${{ env.DOCKER_IMAGE_NAME }}:latest .
          docker push ${{ secrets.AZURE_REGISTRY_NAME }}.azurecr.io/${{ env.DOCKER_IMAGE_NAME }}:${{ github.sha }}
          docker push ${{ secrets.AZURE_REGISTRY_NAME }}.azurecr.io/${{ env.DOCKER_IMAGE_NAME }}:latest

      - name: ðŸš€ éƒ¨ç½²åˆ° Azure Container Instances
        run: |
          az container create \
            --resource-group ${{ secrets.AZURE_RESOURCE_GROUP }} \
            --name ${{ env.AZURE_CONTAINER_NAME }} \
            --image ${{ secrets.AZURE_REGISTRY_NAME }}.azurecr.io/${{ env.DOCKER_IMAGE_NAME }}:latest \
            --registry-login-server ${{ secrets.AZURE_REGISTRY_NAME }}.azurecr.io \
            --registry-username ${{ secrets.AZURE_REGISTRY_USERNAME }} \
            --registry-password ${{ secrets.AZURE_REGISTRY_PASSWORD }} \
            --dns-name-label teacher-roster-${{ secrets.AZURE_RESOURCE_GROUP }} \
            --ports 3001 \
            --environment-variables \
              NODE_ENV=production \
              PORT=3001 \
              DB_HOST=${{ secrets.DB_HOST }} \
              DB_PORT=${{ secrets.DB_PORT }} \
              DB_NAME=${{ secrets.DB_NAME }} \
              DB_USER=${{ secrets.DB_USER }} \
              DB_PASSWORD=${{ secrets.DB_PASSWORD }} \
              DB_SSL_MODE=REQUIRED \
              JWT_SECRET=${{ secrets.JWT_SECRET }} \
              SESSION_SECRET=${{ secrets.SESSION_SECRET }} \
            --restart-policy Always \
            --cpu 1 \
            --memory 1.5

      - name: âœ… Azure éƒ¨ç½²æˆåŠŸ
        run: |
          echo "ðŸŽ‰ æ‡‰ç”¨å·²æˆåŠŸéƒ¨ç½²åˆ° Azureï¼"
          FQDN=$(az container show \
            --resource-group ${{ secrets.AZURE_RESOURCE_GROUP }} \
            --name ${{ env.AZURE_CONTAINER_NAME }} \
            --query ipAddress.fqdn \
            --output tsv)
          echo "ðŸŒ æ‡‰ç”¨ URL: http://$FQDN:3001"
          echo "ðŸ’š å¥åº·æª¢æŸ¥: http://$FQDN:3001/health"

  # =====================================================
  # Job 3: é€šçŸ¥éƒ¨ç½²çµæžœ
  # =====================================================
  notify:
    name: ðŸ“¢ éƒ¨ç½²é€šçŸ¥
    runs-on: ubuntu-latest
    needs: [build-and-push-dockerhub]
    if: always()

    steps:
      - name: ðŸ“Š éƒ¨ç½²æ‘˜è¦
        run: |
          echo "## ðŸš€ éƒ¨ç½²æ‘˜è¦" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **åˆ†æ”¯**: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **æäº¤**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Docker Hub**: âœ… å·²æŽ¨é€" >> $GITHUB_STEP_SUMMARY
          if [ "${{ needs.build-and-deploy-azure.result }}" == "success" ]; then
            echo "- **Azure**: âœ… å·²éƒ¨ç½²" >> $GITHUB_STEP_SUMMARY
          else
            echo "- **Azure**: â­ï¸ å·²è·³éŽï¼ˆæœªé…ç½®ï¼‰" >> $GITHUB_STEP_SUMMARY
          fi
